<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é˜¿çƒçš„è¨˜å¸³è¡¨(ãƒ»âˆ€ãƒ»)ã¤â‘©</title>
    <style>
        /* æ–°é…è‰²æ–¹æ¡ˆï¼š#c8b8db, #ffe787, #ffc759, #272932, #eaf6ff */
        :root {
            --primary-color: #eaf6ff; /* äº®ç™½æ–‡å­— */
            --accent-color: #c8b8db; /* ä¸»é¡Œç´«ç¾…è˜­ (å¼·èª¿è‰²) */
            --bg-color: #272932; /* æ·±æœ¨ç‚­ç° (èƒŒæ™¯) */
            --card-bg: #30333d; /* ç•¥æ·ºçš„å¡ç‰‡èƒŒæ™¯ */
            --stat-bg: #3e414c; /* çµ±è¨ˆå€å¡ŠèƒŒæ™¯ */
            --input-bg: #3e414c; /* è¼¸å…¥æ¡†èƒŒæ™¯ */
            --input-border: #5a5e6b; /* æŸ”å’Œé‚Šæ¡† */
            --success-color: #ffe787; /* äº®é‡‘é»ƒ (é‡‘é¡/æˆåŠŸ) */
            --warning-color: #ffc759; /* æº«æš–ç¥ç€æ©™ (è­¦å‘Š/åˆªé™¤) */
            --glow-shadow: 0 0 10px rgba(200, 184, 219, 0.4); /* æŸ”å’Œç´«ç¾…è˜­å…‰å½± */
        }

        body {
            font-family: 'Segoe UI', Microsoft JhengHei, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
            color: var(--primary-color);
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        /* é€šç”¨å¡ç‰‡æ¨£å¼ */
        .card {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 8px; 
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5); /* é¡¯è‘—é™°å½± */
            margin-bottom: 20px;
            border: 1px solid var(--input-border);
        }

        h2 { 
            margin-top: 0; 
            color: var(--primary-color); 
            border-bottom: 2px solid var(--accent-color); 
            padding-bottom: 10px; 
            display: inline-block;
            font-weight: 500;
        }
        h3 { 
            margin: 0 0 10px 0; 
            color: var(--accent-color); 
            font-size: 1.1em; 
            font-weight: 400;
        }

        /* è¡¨å–®æ¨£å¼ */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
        }

        .form-group { margin-bottom: 10px; }
        label { 
            display: block; 
            margin-bottom: 5px; 
            font-weight: 400; 
            font-size: 0.9em; 
            color: var(--primary-color);
        }
        input, select {
            width: 100%; 
            padding: 10px; 
            border: 1px solid var(--input-border); 
            border-radius: 4px; 
            box-sizing: border-box; 
            font-size: 1em;
            background-color: var(--input-bg); 
            color: var(--primary-color); 
            /* è®“ä¸‹æ‹‰é¸å–®åœ¨æ·±è‰²èƒŒæ™¯ä¸‹ä¿æŒä¸€è‡´ */
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        input:focus, select:focus { 
            border-color: var(--accent-color); 
            outline: none; 
            box-shadow: 0 0 5px var(--accent-color);
        }

        /* æŒ‰éˆ•æ¨£å¼ */
        button.btn-add {
            background-color: var(--accent-color); 
            color: var(--bg-color); /* æ·±è‰²æ–‡å­—åœ¨é«˜äº®æŒ‰éˆ•ä¸Š */
            border: none; 
            padding: 12px 20px;
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 1em; 
            width: 100%; 
            margin-top: 15px;
            transition: background 0.2s, box-shadow 0.2s; 
            font-weight: bold;
        }
        button.btn-add:hover { 
            background-color: #b9a8cf; 
            box-shadow: var(--glow-shadow); 
        }

        /* çµ±è¨ˆå€å¡Šæ¨£å¼ */
        .stat-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .stat-btn {
            padding: 8px 16px;
            border: 1px solid var(--accent-color);
            background: transparent;
            color: var(--accent-color);
            border-radius: 20px; 
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9em;
        }

        .stat-btn.active, .stat-btn:hover {
            background: var(--accent-color);
            color: var(--bg-color);
            box-shadow: 0 0 5px var(--accent-color);
        }

        .stat-result-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .stat-box {
            background: var(--stat-bg);
            padding: 15px;
            border-radius: 8px;
            border-left: 5px solid var(--success-color); /* ä½¿ç”¨é‡‘è‰²å¼·èª¿çµ±è¨ˆ */
        }

        .stat-title { font-weight: bold; font-size: 1.1em; margin-bottom: 5px; color: var(--primary-color); }
        .stat-money { font-size: 0.95em; color: var(--primary-color); line-height: 1.4; }
        .currency-label { font-weight: bold; color: var(--success-color); }

        /* åˆ—è¡¨æ¨£å¼ */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--input-bg); } 
        th { background-color: var(--stat-bg); color: var(--accent-color); font-weight: 600; white-space: nowrap; }
        tr:hover { background-color: #3e414c; } /* æ·±è‰²æ‡¸åœæ•ˆæœ */
        
        .badge {
            display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 0.8em; color: var(--bg-color); /* è®“å¾½ç« æ–‡å­—ç‚ºæ·±è‰² */
            font-weight: bold;
        }
        /* ä¿æŒé¡åˆ¥é¡è‰²é«˜å°æ¯”åº¦ (èˆ‡ dark mode å…¼å®¹) */
        .bg-å„²å€¼ { background: #6a0572; color: white; }
        .bg-èª²é‡‘ { background: #0077b6; color: white; }
        .bg-å®…ç‰© { background: #7c4dff; color: white; }
        .bg-æ—¥å¸¸ { background: #00b894; color: white; }
        .bg-åƒå– { background: #d63031; color: white; }
        .bg-æ‰£æ¬¾ { background: #e17055; color: white; }
        .bg-å…¶ä»– { background: #636e72; color: white; }
        
        /* å¿…è¦æ€§é¡è‰²ä½¿ç”¨ä¸»é¡Œè‰² */
        .bg-å¿…è¦ { background: var(--success-color); color: var(--bg-color); }
        .bg-éå¿…è¦ { background: var(--warning-color); color: var(--bg-color); } 
        .bg-ä¸Šä¾› { background: var(--accent-color); color: var(--bg-color); } 

        .amount { font-weight: bold; color: var(--success-color); } 
        .delete-btn { color: var(--warning-color); cursor: pointer; border: none; background: none; font-weight: bold; }
        .delete-btn:hover { text-decoration: underline; }

        .tools-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .btn-export { 
            background-color: var(--warning-color); /* åŒ¯å‡ºä½¿ç”¨ç¥ç€æ©™ */
            color: var(--bg-color); 
            border: none; 
            padding: 8px 15px; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 0.9em;
        }

        /* éŸ¿æ‡‰å¼ */
        @media (max-width: 600px) {
            .form-grid { grid-template-columns: 1fr; }
            th, td { padding: 8px; font-size: 0.9em; }
            .hide-mobile { display: none; }
            .stat-result-container { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <h2>(ãƒ»âˆ€ãƒ»)ã¤â‘©å†èŠ±éŒ¢å‘€</h2>
        <form id="expenseForm">
            <div class="form-grid">
                <div class="form-group">
                    <label>æ—¥æœŸ</label>
                    <input type="date" id="date" required>
                </div>
                
                <div class="form-group">
                    <label>æ¶ˆè²»é¡åˆ¥</label>
                    <select id="category">
                        <option value="å„²å€¼">å„²å€¼</option>
                        <option value="èª²é‡‘">èª²é‡‘</option>
                        <option value="å®…ç‰©">å®…ç‰©</option>
                        <option value="æ—¥å¸¸">æ—¥å¸¸</option>
                        <option value="åƒå–">åƒå–</option>
                        <option value="æ‰£æ¬¾">æ‰£æ¬¾</option>
                        <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>æ¶ˆè²»å¿…è¦æ€§</label>
                    <select id="necessity">
                        <option value="å¿…è¦">å¿…è¦</option>
                        <option value="éå¿…è¦">éå¿…è¦</option>
                        <option value="ä¸Šä¾›">ä¸Šä¾›</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>é‡‘é¡</label>
                    <input type="number" id="amount" placeholder="0" min="0" step="0.01" required>
                </div>

                <div class="form-group">
                    <label>å¹£åˆ¥</label>
                    <select id="currency">
                        <option value="TWD">å°å¹£ (TWD)</option>
                        <option value="JPY">æ—¥å¹£ (JPY)</option>
                        <option value="CNY">äººæ°‘å¹£ (CNY)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>ä»˜æ¬¾æ–¹å¼</label>
                    <select id="paymentMethod">
                        <option value="ç¾é‡‘">ç¾é‡‘</option>
                        <option value="ä¿¡ç”¨å¡">ä¿¡ç”¨å¡</option>
                        <option value="é‡‘èå¡">é‡‘èå¡</option>
                    </select>
                </div>

                <div class="form-group" style="grid-column: 1 / -1;">
                    <label>æ¶ˆè²»é …ç›® (å‚™è¨»)</label>
                    <input type="text" id="item" placeholder="è‡ªè¡Œå¡«å¯« (å‚™è¨»)" required>
                </div>
            </div>
            <button type="submit" class="btn-add">ï¼‹ æ–°å¢ç´€éŒ„</button>
        </form>
    </div>

    <div class="card">
        <h3>ğŸ“Š è³‡é‡‘çµ±è¨ˆ | ç¸½è¦½</h3>
        <div class="stat-controls">
            <button class="stat-btn active" onclick="updateStats('day', this)">ä¾æ—¥æœŸ</button>
            <button class="stat-btn" onclick="updateStats('month', this)">ä¾æœˆä»½</button>
            <button class="stat-btn" onclick="updateStats('year', this)">ä¾å¹´ä»½</button>
            <button class="stat-btn" onclick="updateStats('category', this)">ä¾é¡åˆ¥</button>
            <button class="stat-btn" onclick="updateStats('necessity', this)">ä¾å¿…è¦æ€§</button> 
            <button class="stat-btn" onclick="updateStats('method', this)">ä¾ä»˜æ¬¾æ–¹å¼</button>
        </div>
        <div id="statResult" class="stat-result-container">
            </div>
    </div>

    <div class="card">
        <div class="tools-header">
            <h2>æ¶ˆè²»æ˜ç´°</h2>
            <button class="btn-export" onclick="exportToCSV()">åŒ¯å‡º Excel</button>
        </div>
        
        <div style="overflow-x:auto;">
            <table id="expenseTable">
                <thead>
                    <tr>
                        <th>æ—¥æœŸ</th>
                        <th>é¡åˆ¥</th>
                        <th>å¿…è¦æ€§</th> 
                        <th>é‡‘é¡</th>
                        <th>é …ç›® (å‚™è¨»)</th>
                        <th class="hide-mobile">ä»˜æ¬¾</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="expenseList"></tbody>
            </table>
        </div>
        <p style="text-align: center; color: var(--input-border); font-size: 0.8em; margin-top: 20px;">
            * è³‡æ–™å„²å­˜æ–¼æœ¬åœ°ç€è¦½å™¨ï¼Œå»ºè­°å®šæœŸåŒ¯å‡ºå‚™ä»½ã€‚
        </p>
    </div>
</div>

<script>
    // è³‡æ–™è®Šæ•¸
    let expenses = [];
    let currentStatMode = 'day';

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('date').valueAsDate = new Date(); // é è¨­ä»Šå¤©
        loadExpenses();
    });

    const form = document.getElementById('expenseForm');
    
    // è¡¨å–®é€å‡º
    form.addEventListener('submit', function(e) {
        e.preventDefault();

        const newExpense = {
            id: Date.now(),
            date: document.getElementById('date').value,
            category: document.getElementById('category').value,
            necessity: document.getElementById('necessity').value, 
            item: document.getElementById('item').value,
            amount: parseFloat(document.getElementById('amount').value),
            currency: document.getElementById('currency').value,
            method: document.getElementById('paymentMethod').value
        };

        expenses.unshift(newExpense);
        saveExpenses();
        renderTable();
        // ç¢ºä¿çµ±è¨ˆåœ¨æ–°å¢å¾Œæ›´æ–°ï¼Œä¸¦ä¿æŒç•¶å‰æ¨¡å¼
        updateStats(currentStatMode, document.querySelector(`.stat-btn[onclick*="${currentStatMode}"]`)); 
        
        form.reset();
        document.getElementById('date').valueAsDate = new Date();
        document.getElementById('currency').value = "TWD"; 
        document.getElementById('paymentMethod').value = "ç¾é‡‘";
        document.getElementById('necessity').value = "å¿…è¦"; 
        document.getElementById('category').value = "å„²å€¼"; 
    });

    // å„²å­˜èˆ‡è®€å–
    function saveExpenses() {
        localStorage.setItem('myExpensesProMax', JSON.stringify(expenses)); 
    }

    function loadExpenses() {
        const stored = localStorage.getItem('myExpensesProMax');
        if (stored) {
            expenses = JSON.parse(stored);
            // è³‡æ–™æ¸…æ´—ï¼šé˜²æ­¢èˆŠè³‡æ–™æ²’æœ‰ category æˆ– necessity æ¬„ä½
            expenses.forEach(e => {
                if(!e.category) e.category = 'æœªåˆ†é¡';
                if(!e.necessity) e.necessity = 'å¿…è¦'; 
            });
        }
        renderTable();
        // åˆå§‹åŒ–æ™‚å‘¼å«çµ±è¨ˆ
        updateStats('day', document.querySelector('.stat-btn.active'));
    }

    // æ¸²æŸ“åˆ—è¡¨
    function renderTable() {
        const list = document.getElementById('expenseList');
        list.innerHTML = '';

        expenses.forEach(exp => {
            // ç”±æ–¼ CSS ä¸­å°‡é¡åˆ¥åç¨±ç›´æ¥ä½œç‚º classï¼Œé€™è£¡ä¿®æ­£ä»¥ç¬¦åˆæ–°çš„é¸é … (å¦‚ï¼šå„²å€¼)
            const categoryClassKey = exp.category.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, '');
            const necessityClassKey = exp.necessity.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, '');
            
            const badgeClass = `bg-${categoryClassKey}`;
            const necessityClass = `bg-${necessityClassKey}`;

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${exp.date}</td>
                <td><span class="badge ${badgeClass}">${exp.category}</span></td>
                <td><span class="badge ${necessityClass}">${exp.necessity}</span></td>
                <td>
                    <span class="amount">${exp.amount}</span> <small>${exp.currency}</small>
                </td>
                <td>${exp.item}</td>
                <td class="hide-mobile">${exp.method}</td>
                <td><button class="delete-btn" onclick="deleteExpense(${exp.id})">åˆªé™¤</button></td>
            `;
            list.appendChild(row);
        });
    }

    function deleteExpense(id) {
        if(confirm('ç¢ºå®šåˆªé™¤é€™ç­†ç´€éŒ„ï¼Ÿ')) {
            expenses = expenses.filter(exp => exp.id !== id);
            saveExpenses();
            renderTable();
            updateStats(currentStatMode, document.querySelector(`.stat-btn[onclick*="${currentStatMode}"]`));
        }
    }

    // --- æ ¸å¿ƒçµ±è¨ˆåŠŸèƒ½ ---
    function updateStats(mode, clickedButton) {
        currentStatMode = mode;
        
        // æ›´æ–°æŒ‰éˆ•æ¨£å¼
        document.querySelectorAll('.stat-btn').forEach(btn => btn.classList.remove('active'));
        if (clickedButton) {
             clickedButton.classList.add('active');
        } else {
            document.querySelector(`.stat-btn[onclick*="${mode}"]`).classList.add('active');
        }


        const container = document.getElementById('statResult');
        container.innerHTML = '';

        // 1. åˆ†çµ„è³‡æ–™
        const groups = {};
        expenses.forEach(exp => {
            let key = '';
            if (mode === 'day') key = exp.date;
            else if (mode === 'month') key = exp.date.substring(0, 7); 
            else if (mode === 'year') key = exp.date.substring(0, 4);  
            else if (mode === 'category') key = exp.category;
            else if (mode === 'method') key = exp.method;
            else if (mode === 'necessity') key = exp.necessity; 

            if (!groups[key]) groups[key] = {};
            
            if (!groups[key][exp.currency]) groups[key][exp.currency] = 0;
            groups[key][exp.currency] += exp.amount;
        });

        // 2. æ’åº (æ—¥æœŸé¡ç”±æ–°åˆ°èˆŠï¼Œå…¶ä»–é †åº)
        const sortedKeys = Object.keys(groups).sort((a, b) => {
            if (mode === 'day' || mode === 'month' || mode === 'year') {
                return b.localeCompare(a); 
            }
            return a.localeCompare(b); 
        }); 

        if (sortedKeys.length === 0) {
            container.innerHTML = `<div style="color:var(--input-border); padding:10px;">å°šç„¡æ•¸æ“šç´€éŒ„ã€‚</div>`;
            return;
        }

        // 3. ç”¢ç”Ÿçµ±è¨ˆå¡ç‰‡
        sortedKeys.forEach(key => {
            const currencies = groups[key];
            let moneyHtml = '';
            for (let curr in currencies) {
                moneyHtml += `<div><span class="currency-label">${curr}</span>: ${currencies[curr].toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>`;
            }

            const box = document.createElement('div');
            box.className = 'stat-box';
            box.innerHTML = `
                <div class="stat-title">${key}</div>
                <div class="stat-money">${moneyHtml}</div>
            `;
            container.appendChild(box);
        });
    }

    // åŒ¯å‡º CSV
    function exportToCSV() {
        if (expenses.length === 0) { alert("æ²’æœ‰è¨˜éŒ„å¯åŒ¯å‡ºã€‚"); return; }
        let csv = "\uFEFFæ—¥æœŸ,é¡åˆ¥,å¿…è¦æ€§,é …ç›®,é‡‘é¡,å¹£åˆ¥,ä»˜æ¬¾æ–¹å¼\n"; 
        expenses.forEach(e => {
            const safeItem = `"${(e.item || '').replace(/"/g, '""')}"`;
            csv += `${e.date},${e.category},${e.necessity},${safeItem},${e.amount},${e.currency},${e.method}\n`;
        });
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `è¨˜å¸³å‚™ä»½_${new Date().toISOString().slice(0,10)}.csv`;
        link.click();
    }
</script>

</body>
</html>